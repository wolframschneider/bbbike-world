#!/usr/local/bin/bash
# Copyright (c) 2009-2022 Wolfram Schneider, https://bbbike.org
#
# planet-download - download the latest planet.osm.pbf file
#                   create a copy without meta data too
#

set -e
set -o pipefail # bash only

if [ -n "$IGNORE_PLANET_OSM" ]; then
	exit 0
fi

: ${MD5=`which md5 md5sum false 2>/dev/null | head -1`}
: ${SHA="shasum -a 256"}

# true or false. If false, we do not keep the 47GB original planet
: ${keep_original_planet="true"}

nice="nice -n 9"

file_latest=planet-latest.osm.pbf
file_nometa=planet-latest-nometa.osm.pbf
planet_osm_server=https://planet.openstreetmap.org/pbf

if [ -e $HOME/.bbbikerc ]; then
    . $HOME/.bbbikerc
fi

# run in temporary directory
dir="tmp.$$.new"
mkdir -p $dir
pwd=`pwd`
cd $dir


if $keep_original_planet; then
  tee_output=$file_latest
else
  tee_output=/dev/null
fi

# get md5 checksum
curl -L -sSf -o $file_latest.md5 $planet_osm_server/$file_latest.md5

# download planet.osm and create the planet without meta data on the fly
time curl --http1.1 --ipv4 -L -sSf $planet_osm_server/$file_latest | tee $tee_output | mbuffer -q -m 128m | \
  $nice osmconvert --drop-author --drop-version --out-pbf - > $file_nometa.tmp
mv -f $file_nometa.tmp $file_nometa

# create timestamp file / nometa
osmconvert --out-timestamp $file_nometa > $file_nometa.timestamp.tmp
mv -f $file_nometa.timestamp.tmp $file_nometa.timestamp

# create timestamp file / original planet
if $keep_original_planet; then
  osmconvert --out-timestamp $file_latest > $file_latest.timestamp.tmp
  mv -f $file_latest.timestamp.tmp $file_latest.timestamp
fi


if $keep_original_planet; then
  cat $file_latest.md5
  $MD5 $file_latest | tee $file_latest.md5
fi
$MD5 $file_nometa | tee $file_nometa.md5

cd $pwd

if $keep_original_planet; then
  mv -f $dir/$file_latest $dir/$file_latest.md5 .
  mv -f $dir/$file_latest.timestamp .
fi
mv -f $dir/$file_nometa $dir/$file_nometa.md5 .
mv -f $dir/$file_nometa.timestamp .

# cleanup temp directory
rm -rf $dir

#EOF
