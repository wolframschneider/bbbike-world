FROM ubuntu:xenial
MAINTAINER Wolfram Schneider <wosch@FreeBSD.org>

ENV DEBIAN_FRONTEND noninteractive

RUN apt-get update -q && apt-get upgrade -y
RUN apt-get install -y git make curl apt-transport-https sudo

RUN mkdir -p /bbbike/projects
WORKDIR /bbbike/projects
ENV HOME /bbbike

RUN useradd -ms /bin/bash tile
RUN echo 'tile   ALL=NOPASSWD: ALL' >> /etc/sudoers
RUN chown -R tile:tile /bbbike/projects
USER tile

# git checkout
RUN mkdir mc
RUN git clone --depth=1 https://github.com/wosch/bbbike.git
WORKDIR /bbbike/projects/bbbike
RUN git clone --depth=1 https://github.com/wosch/bbbike-world.git world
RUN make -f world/Makefile.osm create-makefile-symlinks
RUN ./world/bin/bbbike-deb-repository-setup.sh

# install tile software
RUN make -C./world/tile install-stage1
RUN make -C./world/tile install-stage2
RUN make -C./world/tile install-stage3

# post install
RUN make -C./world/tile openstreetmap-postgis
RUN sudo /usr/bin/install-postgis-osm-user.sh gis "www-data $(whoami) tile"
RUN make create-bbbike-web-symlinks
RUN make -C./world/tile mapnik-restart bbbike-mapnik

# package cleanup
RUN sudo apt-get autoremove
RUN sudo apt-get autoclean
RUN sudo apt-get clean

EXPOSE 80

CMD ["/bin/sh", "-c", "sudo /etc/init.d/rsyslog start && make mapnik-restart && bash"]

# see ./README
